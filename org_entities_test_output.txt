
================================================================================
AUTHENTICATING...
================================================================================
✅ Authenticated as: Llewellyn Nel (llewellyn@bluedawncapital.co.za)
   Role: developer
   Organization ID: 315fa36c-4555-4b2b-8ba3-fdbde31cb940

================================================================================
TEST SUITE 1: ORGANIZATIONAL ENTITIES CRUD (10 tests)
================================================================================

--- Test 1.1: GET All Entities ---

Test 1.1: GET All Entities - ✅ PASSED
  Details: Retrieved 0 entities

--- Test 1.2: GET Entities by Type (company) ---

Test 1.2: GET Entities by Type - ✅ PASSED
  Details: Retrieved 0 companies, all filtered correctly: True

--- Test 1.3: GET Unlinked Entities (level 3, unlinked) ---

Test 1.3: GET Unlinked Entities - ✅ PASSED
  Details: Retrieved 0 unlinked level 3 entities, all without parent_id: True

--- Test 1.4: CREATE New Company Entity (Full Details) ---

Test 1.4: CREATE New Company Entity - ✅ PASSED
  Details: Created entity with ID: 35db99a1-36b2-45ed-a0a6-e810603dcb1b

--- Test 1.5: GET Single Entity ---

Test 1.5: GET Single Entity - ✅ PASSED
  Details: Entity retrieved with all fields populated: True

--- Test 1.6: UPDATE Entity ---

Test 1.6: UPDATE Entity - ✅ PASSED
  Details: Entity updated successfully

--- Test 1.7: Verify Update in Database ---

Test 1.7: Verify Update in Database - ✅ PASSED
  Details: Fields updated correctly: True

--- Test 1.8: DELETE Entity with parent_id (Should Fail) ---

Test 1.8: DELETE Entity with parent_id (Should Fail) - ❌ FAILED
  Details: Failed to link entity: 404

--- Test 1.9: Unlink Entity, Then DELETE ---

Test 1.9: Unlink Entity, Then DELETE - ❌ FAILED
  Details: Unlink failed: 404

--- Test 1.10: Verify Soft Delete ---

Test 1.10: Verify Soft Delete - ❌ FAILED
  Details: Deleted entity not in active list: False

================================================================================
TEST SUITE 2: ENTITY LOGO UPLOAD (3 tests)
================================================================================

--- Test 2.1: Create Entity for Logo Testing ---

Test 2.1: Create Entity for Logo Testing - ✅ PASSED
  Details: Created entity ID: 7f057a2d-87ac-4814-b799-be99111d2d38

--- Test 2.2: Upload Logo ---

Test 2.2: Upload Logo - ✅ PASSED
  Details: Logo uploaded, URL: /api/entities/7f057a2d-87ac-4814-b799-be99111d2d38/logo/69145794ec1b8b733373ece3

--- Test 2.3: Retrieve Logo ---

Test 2.3: Retrieve Logo - ✅ PASSED
  Details: Logo retrieved, Content-Type: image/png

================================================================================
TEST SUITE 3: CUSTOM FIELDS (5 tests)
================================================================================

--- Test 3.1: GET Custom Fields (Initially) ---

Test 3.1: GET Custom Fields (Initially) - ❌ FAILED
  Details: Status: 404

--- Test 3.2: CREATE Custom Field ---

Test 3.2: CREATE Custom Field - ✅ PASSED
  Details: Created custom field ID: 7f31a12a-2614-472f-980c-e24fe461ad5c

--- Test 3.3: GET Custom Fields (Has Data) ---

Test 3.3: GET Custom Fields (Has Data) - ❌ FAILED
  Details: Status: 404

--- Test 3.4: CREATE Duplicate Field (Should Fail) ---

Test 3.4: CREATE Duplicate Field (Should Fail) - ✅ PASSED
  Details: Correctly rejected with 400: Field 'iso_certification' already exists for company

--- Test 3.5: DELETE Custom Field ---

Test 3.5: DELETE Custom Field - ✅ PASSED
  Details: Custom field deleted successfully

================================================================================
TEST SUITE 4: INTEGRATION WITH HIERARCHY (6 tests)
================================================================================

--- Test 4.1: Create Entity in Settings ---

Test 4.1: Create Entity in Settings - ✅ PASSED
  Details: Created entity ID: 55507d4d-428f-4887-b75f-013dbebded0f, parent_id is None: True

--- Test 4.2: Verify Entity is Unlinked ---

Test 4.2: Verify Entity is Unlinked - ✅ PASSED
  Details: Entity appears in unlinked list: True

--- Test 4.3: Link Entity to Hierarchy ---

Test 4.3: Link Entity to Hierarchy - ❌ FAILED
  Details: Status: 404, Response: {"detail":"Child unit not found"}

--- Test 4.4: Verify Entity Now Linked ---

Test 4.4: Verify Entity Now Linked - ❌ FAILED
  Details: Entity now has parent_id: None

--- Test 4.5: GET Hierarchy Shows New Entity ---

❌ CRITICAL ERROR: 'list' object has no attribute 'get'
Traceback (most recent call last):
  File "/app/organizational_entities_backend_test.py", line 592, in <module>
    run_tests()
  File "/app/organizational_entities_backend_test.py", line 489, in run_tests
    found_entity = find_in_hierarchy(hierarchy, hierarchy_entity_id) if hierarchy_entity_id else None
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/organizational_entities_backend_test.py", line 481, in find_in_hierarchy
    if node.get("id") == entity_id:
       ^^^^^^^^
AttributeError: 'list' object has no attribute 'get'
